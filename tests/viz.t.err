GeoTessera Visualization Tests
===============================

These are tests for the `geotessera visualize` and `geotessera webmap` commands.

Setup
-----

Set environment variable to disable fancy terminal output (ANSI codes, boxes, colors):

  $ export TERM=dumb

Create a temporary directory for test outputs and cache:

  $ export TESTDIR="$CRAMTMP/test_outputs"
  $ mkdir -p "$TESTDIR"

Override XDG cache directory to use temporary location (for test isolation):

  $ export XDG_CACHE_HOME="$CRAMTMP/cache"
  $ mkdir -p "$XDG_CACHE_HOME"

Test: Download Tiles for Cambridge Region (Bbox)
-------------------------------------------------

Download tiles covering a small area of Cambridge using a bounding box.
This bbox covers just 4 tiles for faster testing:

  $ uv run -m geotessera.cli download \
  >   --bbox "0.086174,52.183432,0.151062,52.206318" \
  >   --year 2024 \
  >   --format tiff \
  >   --output "$TESTDIR/cb_tiles_tiff" \
  >   --dataset-version v1 2>&1 | grep -E 'SUCCESS|Found.*tiles' | sed 's/ *$//'

Verify TIFF files were created:

  $ [ -n "$(find "$TESTDIR/cb_tiles_tiff/global_0.1_degree_representation/2024" -name "*.tif*" 2>/dev/null)" ] && echo "TIFF files created"
  [1]

Verify NPY files were also created (intermediate format retained for efficient reprocessing):

  $ [ -n "$(find "$TESTDIR/cb_tiles_tiff/global_0.1_degree_representation/2024" -name "grid_*.npy" ! -name "*_scales.npy" 2>/dev/null)" ] && echo "NPY embedding files created"
  [1]

  $ [ -n "$(find "$TESTDIR/cb_tiles_tiff/global_0.1_degree_representation/2024" -name "*_scales.npy" 2>/dev/null)" ] && echo "NPY scales files created"
  [1]

Verify both formats coexist (count files of each type):

  $ find "$TESTDIR/cb_tiles_tiff/global_0.1_degree_representation/2024" -name "*.tif*" 2>/dev/null | wc -l | tr -d ' '
  0

  $ find "$TESTDIR/cb_tiles_tiff/global_0.1_degree_representation/2024" -name "grid_*.npy" ! -name "*_scales.npy" 2>/dev/null | wc -l | tr -d ' '
  0

Test: Visualize - Create PCA Mosaic from TIFF Files
----------------------------------------------------

Create a PCA visualization from the downloaded TIFF files.
The visualize command should:
1. Load all TIFF tiles
2. Apply PCA to reduce 128 channels to RGB
3. Create a mosaic in the target CRS (default EPSG:3857)

  $ uv run -m geotessera.cli visualize \
  >   "$TESTDIR/cb_tiles_tiff" \
  >   "$TESTDIR/cb_pca_mosaic.tif" 2>&1 | grep -A 1 -E 'Found|Created PCA mosaic' | sed 's/ *$//'

Verify PCA mosaic was created:

  $ [ -f "$TESTDIR/cb_pca_mosaic.tif" ] && echo "PCA mosaic created"
  [1]

Check that it's a valid GeoTIFF with 3 bands (RGB):

  $ uv run python -c "import rasterio; r = rasterio.open('$TESTDIR/cb_pca_mosaic.tif'); print(f'Bands: {r.count}, CRS: {r.crs}')"
  /bin/sh: 35: uv: not found
  [127]

Test: Visualize - Custom CRS and Balance Options
-------------------------------------------------

Test creating a visualization with custom CRS and histogram balancing:

  $ uv run -m geotessera.cli visualize \
  >   "$TESTDIR/cb_tiles_tiff" \
  >   "$TESTDIR/cb_pca_4326.tif" \
  >   --crs EPSG:4326 \
  >   --balance histogram 2>&1 | grep -A 1 -E 'Created PCA mosaic' | sed 's/ *$//'

Verify custom CRS mosaic was created:

  $ [ -f "$TESTDIR/cb_pca_4326.tif" ] && echo "Custom CRS mosaic created"
  [1]

  $ uv run python -c "import rasterio; r = rasterio.open('$TESTDIR/cb_pca_4326.tif'); print(f'CRS: {r.crs}')"
  /bin/sh: 45: uv: not found
  [127]

Test: Visualize - NPY Format Input
-----------------------------------

Download the same region in NPY format and create a visualization:

  $ uv run -m geotessera.cli download \
  >   --bbox "0.086174,52.183432,0.151062,52.206318" \
  >   --year 2024 \
  >   --format npy \
  >   --output "$TESTDIR/cb_tiles_npy" \
  >   --dataset-version v1 2>&1 | grep -E 'SUCCESS' | sed 's/ *$//'

Create visualization from NPY format:

  $ uv run -m geotessera.cli visualize \
  >   "$TESTDIR/cb_tiles_npy" \
  >   "$TESTDIR/cb_pca_from_npy.tif" 2>&1 | grep -A 1 -E 'Found|Created PCA mosaic' | sed 's/ *$//'

Verify NPY-based mosaic was created:

  $ [ -f "$TESTDIR/cb_pca_from_npy.tif" ] && echo "NPY format mosaic created"
  [1]

Test: Webmap - Generate Web Tiles and Viewer
---------------------------------------------

Generate web tiles from the PCA mosaic and create an interactive web viewer.
This should:
1. Reproject the mosaic if needed (to EPSG:3857 for web)
2. Generate XYZ web tiles at multiple zoom levels
3. Create an HTML viewer with Leaflet

  $ uv run -m geotessera.cli webmap \
  >   "$TESTDIR/cb_pca_mosaic.tif" \
  >   --output "$TESTDIR/cb_webmap" \
  >   --min-zoom 10 \
  >   --max-zoom 13 2>&1 | grep -A 1 -E 'Web visualization ready|Created web' | grep -v '^--$' | sed 's/ *$//'

Verify web map directory structure was created:

  $ test -d "$TESTDIR/cb_webmap" && echo "Web map directory created"
  [1]

  $ test -f "$TESTDIR/cb_webmap/viewer.html" && echo "HTML viewer created"
  [1]

  $ [ -n "$(find "$TESTDIR/cb_webmap/tiles" -name "*.png" 2>/dev/null)" ] && echo "Web tiles (PNG) created"
  [1]

Check that tiles exist at multiple zoom levels:

  $ find "$TESTDIR/cb_webmap/tiles" -type d -name "1[0-3]" | wc -l | tr -d ' ' | grep -E '[2-4]'
  find: '/tmp/cramtests-rsi5b614/test_outputs/cb_webmap/tiles': No such file or directory
  [1]

Test: Webmap - Custom Output and Settings
------------------------------------------

Test webmap with custom initial zoom and center:

  $ uv run -m geotessera.cli webmap \
  >   "$TESTDIR/cb_pca_4326.tif" \
  >   --output "$TESTDIR/cb_webmap_custom" \
  >   --min-zoom 10 \
  >   --max-zoom 12 \
  >   --initial-zoom 11 2>&1 | grep -A 1 -E 'Web visualization ready' | sed 's/ *$//'

Verify custom web map was created:

  $ test -f "$TESTDIR/cb_webmap_custom/viewer.html" && echo "Custom web map created"
  [1]

Test: Info Command on Visualization Outputs
--------------------------------------------

Test that info command works on the created PCA mosaics:

  $ uv run -m geotessera.cli info --tiles "$TESTDIR/cb_tiles_tiff" 2>&1 | grep -E 'Total tiles|Format|Years' | sed 's/ *$//'

Test: Error Handling - Invalid Input
-------------------------------------

Test that visualize fails gracefully with non-existent input:

  $ uv run -m geotessera.cli visualize \
  >   "$TESTDIR/nonexistent" \
  >   "$TESTDIR/output.tif" 2>&1 | grep -A 1 -E 'No tiles found|Error' | grep -v '^--$'
  [1]

Test that webmap fails gracefully with non-TIFF input:

  $ uv run -m geotessera.cli webmap \
  >   "$TESTDIR/cb_tiles_tiff" 2>&1 | grep -E 'Error.*must be.*tif'
  [1]
