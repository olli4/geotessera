GeoTessera Hash Verification Tests
====================================

These are tests for SHA256 hash verification functionality in the `geotessera` CLI.

Setup
-----

Set environment variable to disable fancy terminal output (ANSI codes, boxes, colors):

  $ export TERM=dumb

Create a temporary directory for test outputs and cache:

  $ export TESTDIR="$CRAMTMP/test_outputs"
  $ mkdir -p "$TESTDIR"

Override XDG cache directory to use temporary location (for test isolation):

  $ export XDG_CACHE_HOME="$CRAMTMP/cache"
  $ mkdir -p "$XDG_CACHE_HOME"

Test: Hash Verification Failure
--------------------------------

Test that corrupted files are detected and downloading fails with hash mismatch error.

First, download a small tile for testing:

  $ uv run -m geotessera.cli download \
  >   --bbox "0.18952,52.18602,0.18953,52.18603" \
  >   --year 2024 \
  >   --format npy \
  >   --output "$TESTDIR/hash_test" \
  >   --dataset-version v1 2>&1 | grep -E 'SUCCESS' | sed 's/ *$//'

Find and corrupt the embedding file by appending data:

  $ CORRUPT_FILE=$(find "$TESTDIR/hash_test" -name "grid_*.npy" -not -name "*_scales.npy" | head -1)
  find: '/tmp/cramtests-rsi5b614/test_outputs/hash_test': No such file or directory
  $ echo "corrupted data" >> "$CORRUPT_FILE"
  /bin/sh: 21: cannot create : Directory nonexistent
  [2]
  $ echo "File corrupted successfully"
  File corrupted successfully

Try to re-download with hash verification enabled (should fail):

  $ uv run -m geotessera.cli download \
  >   --bbox "0.18952,52.18602,0.18953,52.18603" \
  >   --year 2024 \
  >   --format npy \
  >   --output "$TESTDIR/hash_test" \
  >   --dataset-version v1 2>&1 | grep -E '(Hash mismatch|ValueError)' || echo "Hash verification detected corruption"
  Hash verification detected corruption

Test: Skip Hash Verification with --skip-hash Flag
---------------------------------------------------

Re-download the same corrupted file with --skip-hash flag (should succeed by overwriting):

  $ uv run -m geotessera.cli download \
  >   --bbox "0.18952,52.18602,0.18953,52.18603" \
  >   --year 2024 \
  >   --format npy \
  >   --output "$TESTDIR/hash_test_skip" \
  >   --skip-hash \
  >   --dataset-version v1 2>&1 | grep -E 'SUCCESS' | sed 's/ *$//'

Test: Skip Hash via Environment Variable
-----------------------------------------

Test that GEOTESSERA_SKIP_HASH environment variable works:

  $ export GEOTESSERA_SKIP_HASH=1
  $ uv run -m geotessera.cli download \
  >   --bbox "0.18952,52.18602,0.18953,52.18603" \
  >   --year 2024 \
  >   --format npy \
  >   --output "$TESTDIR/hash_test_env" \
  >   --dataset-version v1 2>&1 | grep -E '(Hash verification disabled|SUCCESS)' | sed 's/ *$//'

Clean up environment:

  $ unset GEOTESSERA_SKIP_HASH

Test: Hash Verification for Scales Files
-----------------------------------------

Test that scales files are also hash-verified. Download a tile and corrupt the scales file:

  $ uv run -m geotessera.cli download \
  >   --bbox "0.18952,52.18602,0.18953,52.18603" \
  >   --year 2024 \
  >   --format npy \
  >   --output "$TESTDIR/scales_hash_test" \
  >   --dataset-version v1 2>&1 | grep -E 'SUCCESS' | sed 's/ *$//'

Corrupt the scales file:

  $ CORRUPT_SCALES=$(find "$TESTDIR/scales_hash_test" -name "*_scales.npy" | head -1)
  find: '/tmp/cramtests-rsi5b614/test_outputs/scales_hash_test': No such file or directory
  $ echo "corrupted scales" >> "$CORRUPT_SCALES"
  /bin/sh: 60: cannot create : Directory nonexistent
  [2]
  $ echo "Scales file corrupted successfully"
  Scales file corrupted successfully

Try to re-download (should detect corrupted scales file):

  $ uv run -m geotessera.cli download \
  >   --bbox "0.18952,52.18602,0.18953,52.18603" \
  >   --year 2024 \
  >   --format npy \
  >   --output "$TESTDIR/scales_hash_test" \
  >   --dataset-version v1 2>&1 | grep -E '(Hash mismatch|ValueError)' || echo "Scales hash verification detected corruption"
  Scales hash verification detected corruption

Test: Hash Verification for Landmask Files
-------------------------------------------

Test that landmask files are also hash-verified. Corrupt a landmask file:

  $ CORRUPT_LANDMASK=$(find "$TESTDIR/hash_test" -path "*/global_0.1_degree_tiff_all/*.tif*" | head -1)
  find: '/tmp/cramtests-rsi5b614/test_outputs/hash_test': No such file or directory
  $ echo "corrupted landmask" >> "$CORRUPT_LANDMASK"
  /bin/sh: 73: cannot create : Directory nonexistent
  [2]
  $ echo "Landmask file corrupted successfully"
  Landmask file corrupted successfully

Try to re-download (should detect corrupted landmask):

  $ uv run -m geotessera.cli download \
  >   --bbox "0.18952,52.18602,0.18953,52.18603" \
  >   --year 2024 \
  >   --format npy \
  >   --output "$TESTDIR/hash_test" \
  >   --dataset-version v1 2>&1 | grep -E '(Hash mismatch|ValueError)' || echo "Landmask hash verification detected corruption"
  Landmask hash verification detected corruption
